// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Shared schema with backoffice
// Both frontoffice and backoffice use the same database

// NextAuth.js Models
model Account {
    id                String  @id @default(cuid())
    userId            String  @map("user_id")
    type              String
    provider          String
    providerAccountId String  @map("provider_account_id")
    refresh_token     String? @db.Text
    access_token      String? @db.Text
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String? @db.Text
    session_state     String?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
    @@map("accounts")
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique @map("session_token")
    userId       String   @map("user_id")
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@map("sessions")
}

model User {
    id                   String             @id @default(cuid())
    name                 String?
    email                String             @unique
    emailVerified        DateTime?          @map("email_verified")
    password             String?
    image                String?
    role                 UserRole           @default(ATTENDEE)
    subscriptionStatus   SubscriptionStatus @default(FREE) @map("subscription_status")
    subscriptionEndDate  DateTime?          @map("subscription_end_date")
    stripeCustomerId     String?            @unique @map("stripe_customer_id")
    stripeSubscriptionId String?            @unique @map("stripe_subscription_id")
    groupCount           Int                @default(0) @map("group_count")
    createdAt            DateTime           @default(now()) @map("created_at")
    updatedAt            DateTime           @updatedAt @map("updated_at")

    accounts         Account[]
    sessions         Session[]
    ownedGroups      Group[]          @relation("GroupOwner")
    groupMemberships GroupMember[]
    eventRSVPs       EventRSVP[]
    moderatedGroups  GroupModerator[]
    createdEvents    Event[]          @relation("EventCreator")

    @@map("users")
}

model VerificationToken {
    identifier String
    token      String
    expires    DateTime

    @@unique([identifier, token])
    @@map("verification_tokens")
}

// Tavia Business Models - Community Platform

model Group {
    id            String   @id @default(cuid())
    ownerId       String   @map("owner_id")
    name          String
    slug          String   @unique
    description   String?  @db.Text
    image         String?
    category      String
    isPublic      Boolean  @default(true) @map("is_public")
    isPremium     Boolean  @default(false) @map("is_premium")
    memberCount   Int      @default(0) @map("member_count")
    maxMembers    Int      @default(50) @map("max_members")
    location      String?
    latitude      Float?
    longitude     Float?
    brandingLogo  String?  @map("branding_logo")
    brandingColor String?  @map("branding_color")
    customDomain  String?  @unique @map("custom_domain")
    isActive      Boolean  @default(true) @map("is_active")
    createdAt     DateTime @default(now()) @map("created_at")
    updatedAt     DateTime @updatedAt @map("updated_at")

    owner      User             @relation("GroupOwner", fields: [ownerId], references: [id], onDelete: Cascade)
    members    GroupMember[]
    events     Event[]
    moderators GroupModerator[]

    @@index([slug])
    @@index([ownerId])
    @@index([category])
    @@index([isActive])
    @@index([isPublic])
    @@map("groups")
}

model GroupMember {
    id        String           @id @default(cuid())
    groupId   String           @map("group_id")
    userId    String           @map("user_id")
    role      GroupMemberRole  @default(MEMBER)
    status    MembershipStatus @default(PENDING)
    joinedAt  DateTime         @default(now()) @map("joined_at")
    createdAt DateTime         @default(now()) @map("created_at")
    updatedAt DateTime         @updatedAt @map("updated_at")

    group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
    user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([groupId, userId])
    @@index([groupId])
    @@index([userId])
    @@index([status])
    @@map("group_members")
}

model GroupModerator {
    id        String   @id @default(cuid())
    groupId   String   @map("group_id")
    userId    String   @map("user_id")
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
    user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([groupId, userId])
    @@index([groupId])
    @@index([userId])
    @@map("group_moderators")
}

model Event {
    id            String      @id @default(cuid())
    groupId       String      @map("group_id")
    createdById   String      @map("created_by_id")
    title         String
    slug          String      @unique
    description   String?     @db.Text
    image         String?
    category      String
    startDate     DateTime    @map("start_date")
    endDate       DateTime?   @map("end_date")
    location      String?
    latitude      Float?
    longitude     Float?
    capacity      Int?
    isOnline      Boolean     @default(false) @map("is_online")
    meetingUrl    String?     @map("meeting_url")
    isFree        Boolean     @default(true) @map("is_free")
    price         Decimal?    @db.Decimal(10, 2)
    currency      String?     @default("USD")
    status        EventStatus @default(DRAFT)
    rsvpCount     Int         @default(0) @map("rsvp_count")
    attendeeCount Int         @default(0) @map("attendee_count")
    isActive      Boolean     @default(true) @map("is_active")
    createdAt     DateTime    @default(now()) @map("created_at")
    updatedAt     DateTime    @updatedAt @map("updated_at")

    group     Group       @relation(fields: [groupId], references: [id], onDelete: Cascade)
    createdBy User        @relation("EventCreator", fields: [createdById], references: [id], onDelete: Cascade)
    rsvps     EventRSVP[]

    @@index([slug])
    @@index([groupId])
    @@index([createdById])
    @@index([category])
    @@index([startDate])
    @@index([status])
    @@index([isActive])
    @@map("events")
}

model EventRSVP {
    id          String     @id @default(cuid())
    eventId     String     @map("event_id")
    userId      String     @map("user_id")
    status      RSVPStatus @default(GOING)
    checkedIn   Boolean    @default(false) @map("checked_in")
    checkedInAt DateTime?  @map("checked_in_at")
    createdAt   DateTime   @default(now()) @map("created_at")
    updatedAt   DateTime   @updatedAt @map("updated_at")

    event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
    user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([eventId, userId])
    @@index([eventId])
    @@index([userId])
    @@index([status])
    @@map("event_rsvps")
}

// Enums
enum UserRole {
    ATTENDEE
    ORGANIZER
    MODERATOR
    ADMIN
}

enum SubscriptionStatus {
    FREE
    PREMIUM
    TRIAL
    CANCELED
}

enum GroupMemberRole {
    MEMBER
    MODERATOR
    ADMIN
}

enum MembershipStatus {
    PENDING
    ACTIVE
    INACTIVE
    BANNED
}

enum AnalyticsEventType {
    CLICK
    PAGEVIEW
    CUSTOM
}

enum EventStatus {
    DRAFT
    PUBLISHED
    CANCELED
    COMPLETED
}

enum RSVPStatus {
    GOING
    INTERESTED
    NOT_GOING
}

// Analytics Models
model AnalyticsEvent {
    id        String             @id @default(cuid())
    type      AnalyticsEventType
    timestamp DateTime
    sessionId String?            @map("session_id")

    // Browser context
    url            String
    referrer       String?
    userAgent      String  @map("user_agent") @db.Text
    screenWidth    Int?    @map("screen_width")
    screenHeight   Int?    @map("screen_height")
    viewportWidth  Int?    @map("viewport_width")
    viewportHeight Int?    @map("viewport_height")

    // Click event data
    elementType    String?  @map("element_type")
    elementText    String?  @map("element_text") @db.Text
    elementId      String?  @map("element_id")
    elementClasses String[] @map("element_classes")
    clickX         Int?     @map("click_x")
    clickY         Int?     @map("click_y")
    eventName      String?  @map("event_name")

    // Page view data
    pageTitle String? @map("page_title")
    pagePath  String? @map("page_path")

    // Custom event data
    customName       String? @map("custom_name")
    customProperties Json?   @map("custom_properties")

    // Common metadata
    metadata  Json?
    createdAt DateTime @default(now()) @map("created_at")

    @@index([type])
    @@index([timestamp])
    @@index([sessionId])
    @@index([eventName])
    @@index([pagePath])
    @@map("analytics_events")
}
